;---------------------------------------------------------
;アイテム出現条件
;---------------------------------------------------------
@SALEITEM_CHECK
;1つ以上持ってる場合はITEMSALESを0にする。持ってない場合は販売中(ITEMSALESが1)になる
;既にアイテムがあるのに販売中になっているという不自然な状態をここでまとめてチェックする
FOR LOCAL, 0, 100
	SIF STRLENS(ITEMNAME:LOCAL) == 0
		CONTINUE
	IF ITEM:LOCAL
		ITEMSALES:LOCAL = 0
	ELSE
		ITEMSALES:LOCAL = 1
	ENDIF
NEXT

;ローション、媚薬、ビデオテープはとりあえず99個まで
ITEMSALES:25 = 1
ITEMSALES:26 = 1
ITEMSALES:27 = 1
ITEMSALES:29 = 1
ITEMSALES:30 = 1
ITEMSALES:31 = 1
ITEMSALES:33 = 1
ITEMSALES:34 = 1
ITEMSALES:35 = 1
SIF ITEM:25 >= 99
	ITEMSALES:25 = 0
SIF ITEM:26 >= 99
	ITEMSALES:26 = 0
SIF ITEM:27 >= 99
	ITEMSALES:27 = 0
SIF ITEM:28 >= 99
	ITEMSALES:28 = 0
SIF ITEM:29 >= 99
	ITEMSALES:29 = 0
SIF ITEM:30 >= 99
	ITEMSALES:30 = 0
SIF ITEM:31 >= 99
	ITEMSALES:31 = 0
SIF ITEM:33 >= 99
	ITEMSALES:33 = 0
SIF ITEM:34 >= 99
	ITEMSALES:34 = 0
SIF ITEM:35 >= 99
	ITEMSALES:35 = 0

;コンフィグで妊娠機能オンじゃないとダメ
;33,排卵誘発剤 34,緊急避妊薬
IF (FLAG:62 & 1) == 0
	ITEMSALES:33 = 0
	ITEMSALES:34 = 0
ENDIF

;コンフィグでＡ系コマンド拡張がONになってないと無理
;15,浣腸器具一式 20,アナルビーズ
IF (FLAG:61 & 1p5) == 0
	ITEMSALES:15 = 0
	ITEMSALES:20 = 0
ENDIF

;主人か助手が『禁断の知識』を持っている
F = 0
IF TALENT:MASTER:125
	F = 1
	ITEMSALES:66 = 0
ELSEIF ASSI >= 0
	SIF TALENT:ASSI:125
		F = 1
ENDIF
;助手全体から禁断の知識を検索
REPEAT CHARANUM
	IF COUNT == 0
		CONTINUE
	ELSEIF CFLAG:COUNT:21
		CONTINUE
	ELSEIF ISASSI:COUNT == 1
		SIF TALENT:COUNT:125
			F = 1
	ENDIF
REND

;主人か助手が『調合知識』を持っている
P = 0
IF TALENT:MASTER:55
	P = 1
	ITEMSALES:65 = 0
ELSEIF ASSI >= 0
	SIF TALENT:ASSI:55
		P = 1
ENDIF
;助手全体から調合知識を検索
REPEAT CHARANUM
	IF COUNT == 0
		CONTINUE
	ELSEIF CFLAG:COUNT:21
		CONTINUE
	ELSEIF ISASSI:COUNT == 1
		SIF TALENT:COUNT:55
			P = 1
	ENDIF
REND

ITEMSALES:71 = 0
ITEMSALES:72 = 0
ITEMSALES:73 = 0
ITEMSALES:74 = 0
ITEMSALES:75 = 0
ITEMSALES:76 = 0
ITEMSALES:77 = 0
ITEMSALES:78 = 0
ITEMSALES:79 = 0
ITEMSALES:80 = 0
ITEMSALES:81 = 0
IF F || P
	REPEAT CHARANUM
		SIF CFLAG:COUNT:21
			CONTINUE
		;71,薬の材料(双),20000,;ふたなりにする
		;既になっていたらダメ
		IF TALENT:COUNT:121 == 0 && TALENT:COUNT:122 == 0
			;禁断の知識がない場合、対象に調合知識か不思議な根か具現が必要
			SIF F || (TALENT:COUNT:55 || TALENT:COUNT:120 || TALENT:COUNT:127)
				ITEMSALES:71 = 1
		ENDIF
		;72,薬の材料(消),10000,;ふたなりを消去する
		SIF TALENT:COUNT:121 && TALENT:COUNT:122 == 0
			ITEMSALES:72 = 1
		;73,青の飴玉,20000,;体が成長するキャンディ。母乳体質になる
		;すでに母乳体質だとダメ、禁断の知識でないとダメ
		SIF F && TALENT:COUNT:130 == 0 && TALENT:COUNT:122 == 0
			ITEMSALES:73 = 1
		;74,赤の飴玉,20000,;体が若返るキャンディ。処女膜が再生する
		;処女は対象外、禁断の知識でないとダメ
		SIF F && TALENT:COUNT:0 == 0 && TALENT:COUNT:122 == 0
			ITEMSALES:74 = 1
		;75,豊胸剤,20000,;胸の大きさを1段階上げる。
		;巨乳だとダメ
		SIF TALENT:COUNT:110 == 0 && TALENT:COUNT:122 == 0
			ITEMSALES:75 = 1
		;76,縮胸剤,10000,;胸の大きさを1段階下げる。
		;貧乳だとダメ
		SIF TALENT:COUNT:109 == 0 && TALENT:COUNT:122 == 0
			ITEMSALES:76 = 1
		;77,止乳剤,5000,;母乳が出なくなる
		;母乳体質じゃないとダメ
		SIF TALENT:COUNT:130 && TALENT:COUNT:122 == 0
			ITEMSALES:77 = 1
		;78,尿漏れ改善薬,5000,;お漏らし癖が直る。
		;お漏らし癖じゃないとダメ
		SIF TALENT:COUNT:57
			ITEMSALES:78 = 1
		;79,黄の飴玉,20000,;卵を産ませる
		;妊娠中もしくは産卵経験が1以上じゃないとダメ
		SIF TALENT:COUNT:134 || EXP:COUNT:60 > 0
			ITEMSALES:79 = 1
		;80,金の飴玉,30000,;小柄体型持ちを成長させる
		;小柄体系でないとダメ
		SIF TALENT:COUNT:100
			ITEMSALES:80 = 1
		;81,黒の飴玉,50000,;EX化させる
		;まだEX化していなくて、EX化が可能なキャラでないと使用できない
		SIF CFLAG:COUNT:0 == 0 && ABLE_EX_CHANGES(COUNT)
			ITEMSALES:81 = 1
	REND
ENDIF

;エンゲージリング（Jではコマンド：プレゼントで渡す）
ITEMSALES:85 = 0

;赤い首輪（奴隷エンド条件はここで処理）
ITEMSALES:86 = 0
IF TARGET > 0 && ASSI < 0 && FLAG:5 != 9 && ITEM:85 == 0 && ITEM:86 == 0
	SIF TALENT:76 && TALENT:85 && TALENT:89 == 0 && TALENT:180 == 0 && CFLAG:2 >= 2500 && MARK:2 >= 3 && MARK:3 == 0 && (ABL:親密+ABL:欲望+ABL:奉仕精神 >= 15) && (ABL:技巧+ABL:マゾっ気+ABL:精液中毒 >= 13) && (EXP:0+EXP:1 >= 200) && EXP:11 >= 150 && EXP:22 >= 150 && EXP:40 < 500
		ITEMSALES:86 = 1
ENDIF

;隷属の証
ITEMSALES:87 = 0
IF TARGET > 0 && ASSI < 0 && FLAG:1 < 9
	IF TALENT:MASTER:122 && EXP:40 >= 1500
		ITEMSALES:87 = 0
	ELSEIF TALENT:76 && TALENT:85 && TALENT:89 == 0 && TALENT:180 == 0 && MARK:2 >= 3 && MARK:3 == 0 && (ABL:親密+ABL:欲望 >= 8) && (ABL:技巧+ABL:奉仕精神 >= 7) && (ABL:マゾっ気 >= 2 && ABL:自慰中毒 >= 2 && ABL:精液中毒 >= 2) && (EXP:0+EXP:1 >= 100) && EXP:11 >= 50 && EXP:22 >= 50
		ITEMSALES:87 = 1
	ENDIF
ENDIF

;触手使役術
ITEMSALES:24 = 0
SIF F == 1 && ITEM:24 == 0
	ITEMSALES:24 = 1

;元気になる薬
ITEMSALES:70 = 0
IF P
	REPEAT CHARANUM
		SIF CFLAG:COUNT:21
			CONTINUE
		SIF BASE:COUNT:0 != MAXBASE:COUNT:0
			ITEMSALES:70 = 1
	REND
ENDIF

;記憶消去薬
ITEMSALES:98 = 0
SIF F && P
	ITEMSALES:98 = 1

;汚れ無視
ITEMSALES:62 = 0
SIF TALENT:MASTER:64 == 0
	ITEMSALES:62 = 1

;サド
ITEMSALES:63 = 0
SIF TALENT:MASTER:83 == 0
	ITEMSALES:63 = 1

;主人がオトコかふたなりで、早漏ではない
ITEMSALES:64 = 0
SIF (TALENT:MASTER:121 || TALENT:MASTER:122) && TALENT:MASTER:133 == 0
	ITEMSALES:64 = 1


;調合知識(封印中)
ITEMSALES:65 = 0
SIF F && P
	ITEMSALES:65 = 1

;技巧
ITEMSALES:60 = 0
SIF ABL:MASTER:技巧 < 9999
	ITEMSALES:60 = 1

;撮影技能
ITEMSALES:61 = 0
SIF ITEM:6 && ABL:MASTER:撮影技能 < 9999
	ITEMSALES:61 = 1
;編集機材
ITEMSALES:59 = 0
SIF ITEM:6 && ITEM:59 == 0
	ITEMSALES:59 = 1

;プラカード
ITEMSALES:46 = 0
SIF FLAG:1 >= 1 && ITEM:46 == 0
	ITEMSALES:46 = 1

;結界操作と変身魔法
ITEMSALES:67 = 0
ITEMSALES:68 = 0
SIF TALENT:MASTER:211 == 0 && F
	ITEMSALES:67 = 1
SIF TALENT:MASTER:212 == 0 && F
	ITEMSALES:68 = 1

;83,虹の飴玉,500000,;プレイヤーの性別を変える
ITEMSALES:83 = 0
SIF F && P
	ITEMSALES:83 = 1

;---------------------------------------------------------
;アイテム購入
;---------------------------------------------------------
@EVENTBUY
;購入したことを分かりやすくしてみよう
SIF BOUGHT < 25 || (BOUGHT >= 40 && BOUGHT < 60) || BOUGHT >= 70
	PRINTFORMW ＜%ITEMNAME:BOUGHT%を購入しました＞
SIF BOUGHT > 61 && BOUGHT < 69
	PRINTFORMW ＜%ITEMNAME:BOUGHT%を身につけました＞
;調教アイテムは買ったら消える
SIF BOUGHT < 25 || BOUGHT >= 40
	ITEMSALES:BOUGHT = 0
;素質アイテム、キャラカードは買ったら消える
IF (BOUGHT >= 60 && BOUGHT < 84) || BOUGHT == 98
	ITEMSALES:BOUGHT = 0
	ITEM:BOUGHT = 0
ENDIF

;特殊アイテム【初月の証】
IF BOUGHT == 99
	ITEM:BOUGHT = 1
	PRINTFORMW 初月モードに突入しました(高レベルへのLvUPに必要な珠軽減)
ENDIF

;素質アイテム【技巧Lv】
IF BOUGHT == 60 && ABL:MASTER:技巧 < 9999
	;計算しやすいようにシステムでまず引かれる金額を戻しておき、購入した場合引くようにする
	MONEY += 5000
	
	A = 5000
	IF ABL:MASTER:技巧 >= 6
		B = (ABL:MASTER:技巧 - 2) * (ABL:MASTER:技巧 - 5) / 2
	ELSE
		B = 1
	ENDIF
	C = A * B

	DRAWLINE
	IF MONEY < C
		PRINTFORML 次のLvになるためには【技巧Lv】が{B}個必要です(合計費用 ${C})
		PRINTFORMW お金が足りません
		ITEMSALES:BOUGHT = 1
		RETURN 0
	ELSE
		PRINTFORML ＜今の技巧Lv：{ABL:MASTER:技巧}＞
		PRINTFORML 次のLvになるためには【技巧Lv】が{B}個必要です(合計費用 ${C})
		PRINTFORML 購入しますか？
		PRINTL [0] はい
		PRINTL [1] いいえ
		CALL ABL2_CHECK
		PRINTFORML [2] お金が無くなるまでレベルを上げる（Lv：{(ABL:MASTER:技巧)+K}までLvUP　使用金額:${M}）
	ENDIF
	
	$INPUT_LOOP
	INPUT
	
	IF RESULT == 0
		MONEY -= C
		ABL:MASTER:技巧 += 1
		PRINTFORMW ＜%NAME:MASTER%の技巧Lvが1つ上がった　今の技巧Lv：{ABL:MASTER:技巧}＞
		SIF ABL:MASTER:技巧 < 9999
			ITEMSALES:BOUGHT = 1
	ELSEIF RESULT == 1
		ITEMSALES:BOUGHT = 1
		RETURN 0
	ELSEIF RESULT == 2
		MONEY -= M
		ABL:MASTER:技巧 += K
		PRINTFORMW ＜%NAME:MASTER%の技巧Lvが{K}上がった　今の技巧Lv：{ABL:MASTER:技巧}＞
		SIF ABL:MASTER:技巧 < 9999
			ITEMSALES:BOUGHT = 1
	ELSE
		PRINTFORML 正しい値を入力してください
		GOTO INPUT_LOOP
	ENDIF
	RETURN 1
ENDIF
;主人専用能力アップアイテム【撮影技能】
IF BOUGHT == 61 && ABL:MASTER:撮影技能 < 9999
	;計算しやすいようにシステムでまず引かれる金額を戻しておき、購入した場合引くようにする
	MONEY += 30000
	
	A = 30000
	IF ABL:MASTER:撮影技能 >= 9
		B = (ABL:MASTER:撮影技能 - 2) * (ABL:MASTER:撮影技能 - 5) / 12
	ELSE
		B = 1
	ENDIF
	C = A * B

	DRAWLINE
	IF MONEY < C
		PRINTFORML 次のLvになるためには【撮影技能】が{B}個必要です(合計費用 ${C})
		PRINTFORMW お金が足りません
		ITEMSALES:BOUGHT = 1
		RETURN 0
	ELSE
		PRINTFORML ＜今の撮影技能Lv：{ABL:MASTER:撮影技能}＞
		PRINTFORML 次のLvになるためには【撮影技能】が{B}個必要です(合計費用 ${C})
		PRINTFORML 購入しますか？
		PRINTL [0] はい
		PRINTL [1] いいえ
		CALL ABL91_CHECK
		PRINTFORML [2] お金が無くなるまでレベルを上げる（Lv：{(ABL:MASTER:撮影技能)+K}までLvUP　使用金額:${M}）
	ENDIF
	
	$INPUT_LOOP_ASA
	INPUT
	
	IF RESULT == 0
		MONEY -= C
		ABL:MASTER:撮影技能 += 1
		PRINTFORMW ＜%NAME:MASTER%の撮影技能Lvが1つ上がった　今の撮影技能Lv：{ABL:MASTER:撮影技能}＞
		SIF ABL:MASTER:撮影技能 < 9999
			ITEMSALES:BOUGHT = 1
	ELSEIF RESULT == 1
		ITEMSALES:BOUGHT = 1
		RETURN 0
	ELSEIF RESULT == 2
		MONEY -= M
		ABL:MASTER:撮影技能 += K
		PRINTFORMW ＜%NAME:MASTER%の撮影技能Lvが{K}上がった　今の撮影技能Lv：{ABL:MASTER:撮影技能}＞
		SIF ABL:MASTER:撮影技能 < 9999
			ITEMSALES:BOUGHT = 1
	ELSE
		PRINTFORML 正しい値を入力してください
		GOTO INPUT_LOOP
	ENDIF
	RETURN 1
ENDIF
;素質アイテム【汚れ無視】
SIF BOUGHT == 62
	TALENT:MASTER:64 = 1
;素質アイテム【サド】
SIF BOUGHT == 63
	TALENT:MASTER:83 = 1
;素質アイテム【早漏】
SIF BOUGHT == 64
	TALENT:MASTER:133 = 1
;素質アイテム【調合知識】
SIF BOUGHT == 65
	TALENT:MASTER:55 = 1
;素質アイテム【禁断の知識】
SIF BOUGHT == 66
	TALENT:MASTER:125 = 1
;素質アイテム【変身魔法を使う程度の能力】
SIF BOUGHT == 67
	TALENT:MASTER:211 = 1
;素質アイテム【結界を操る程度の能力】
SIF BOUGHT == 68
	TALENT:MASTER:212 = 1
;性転換
IF BOUGHT == 83
	PRINTFORML %CALLNAME:MASTER%の性別を反転できます。購入しますか？
	PRINTL [0] はい
	PRINTL [1] いいえ

	$INPUT_LOOP3
	INPUT
	
	IF RESULT != 0 && RESULT != 1
		PRINTFORML 正しい値を入力してください
		GOTO INPUT_LOOP3
	ENDIF

	IF RESULT == 0
		;虹の飴玉(性転換)
		CALL USE_DRUG_83
	ELSE
		;払い戻し
		MONEY += 500000
		ITEMSALES:BOUGHT = 1
		RETURN 0
	ENDIF
	ITEMSALES:BOUGHT = 1
	RETURN 1
ENDIF

SIF BOUGHT == 25 || BOUGHT == 26 || BOUGHT == 27 || BOUGHT == 28 || BOUGHT == 29 || BOUGHT == 30 || BOUGHT == 31 || BOUGHT == 33 || BOUGHT == 34 || BOUGHT == 35
	CALL BUY_PLURAL
SIF BOUGHT == 70 || BOUGHT == 71 || BOUGHT == 72 || BOUGHT == 73 || BOUGHT == 74 || BOUGHT == 75 || BOUGHT == 76 || BOUGHT == 77 || BOUGHT == 78 || BOUGHT == 79 || BOUGHT == 80 || BOUGHT == 85 || BOUGHT == 86 || BOUGHT == 87 || BOUGHT == 98
	CALL USE_ITEM

;---------------------------------------------------------
;技巧必要金額チェック
;---------------------------------------------------------
@ABL2_CHECK
VARSET LOCAL, 0
VARSET K, 0
VARSET M, 0
LOCAL:1 = ABL:MASTER:技巧
LOCAL:2 = 9999 - ABL:MASTER:技巧

FOR LOCAL, 0, LOCAL:2
	IF ABL:MASTER:技巧 >= 6
		B = (ABL:MASTER:技巧 - 2) * (ABL:MASTER:技巧 - 5) / 2
	ELSE
		B = 1
	ENDIF
	LOCAL:3 = 5000 * B
	SIF M + LOCAL:3 > MONEY
		BREAK
	M += LOCAL:3
	K += 1
	ABL:MASTER:技巧 += 1
NEXT

ABL:MASTER:技巧 = LOCAL:1

;---------------------------------------------------------
;撮影技能必要金額チェック
;---------------------------------------------------------
@ABL91_CHECK
VARSET LOCAL, 0
VARSET K, 0
VARSET M, 0
LOCAL:1 = ABL:MASTER:撮影技能
LOCAL:2 = 9999 - ABL:MASTER:撮影技能

FOR LOCAL, 0, LOCAL:2
	IF ABL:MASTER:撮影技能 >= 9
		B = (ABL:MASTER:撮影技能 - 2) * (ABL:MASTER:撮影技能 - 5) / 12
	ELSE
		B = 1
	ENDIF
	LOCAL:3 = 30000 * B
	SIF M + LOCAL:3 > MONEY
		BREAK
	M += LOCAL:3
	K += 1
	ABL:MASTER:撮影技能 += 1
NEXT

ABL:MASTER:撮影技能 = LOCAL:1

;---------------------------------------------------------
;複数個所持可能なアイテムについて、同時購入個数を選択
;---------------------------------------------------------
@BUY_PLURAL
;現在の購入可能数、Bは所持可能最大数（現在100個）、Cは所持金によるもの
;普通に99個までしか買える仕様になってないし、最大数は99個と判断
;ここに飛んで来た時点で一個購入してしまってるので、払い戻し処理をしておく
MONEY += ITEMPRICE:BOUGHT
ITEM:BOUGHT -= 1
DRAWLINE
PRINTFORML %ITEMNAME:BOUGHT%をいくつ買いますか？ (現在 {ITEM:BOUGHT}個所持)
CALL INPUT_MANY(0, MIN(MONEY/ITEMPRICE:BOUGHT, 99 - ITEM:BOUGHT))
IF RESULT == 0
	RETURN 0
ELSEIF RESULT == 1
	PRINTFORMW ＜%ITEMNAME:BOUGHT%を購入しました＞
	ITEM:BOUGHT += RESULT
	MONEY -= ITEMPRICE:BOUGHT*RESULT
	RETURN 0
ELSE
	PRINTFORMW ＜%ITEMNAME:BOUGHT%を{RESULT}個購入しました＞
	ITEM:BOUGHT += RESULT
	MONEY -= ITEMPRICE:BOUGHT*RESULT
	RETURN 0
ENDIF

;アイテム使用
@USE_ITEM
DRAWLINE
PRINTFORM %ITEMNAME:BOUGHT%:
;アイテムの効果を表示する
SIF BOUGHT == 70
	PRINTL 体力を回復します
SIF BOUGHT == 71
	PRINTL ふたなりになります
SIF BOUGHT == 72
	PRINTL ふたなりを消去します
SIF BOUGHT == 73
	PRINTL 母乳体質になります
SIF BOUGHT == 74
	PRINTL 処女膜が再生します
SIF BOUGHT == 75
	PRINTL 胸を大きくします
SIF BOUGHT == 76
	PRINTL 胸を小さくします
SIF BOUGHT == 77
	PRINTL 母乳が出なくなります
SIF BOUGHT == 78
	PRINTL お漏らし癖が治ります
SIF BOUGHT == 79
	PRINTL 強制的に卵を産ませます
SIF BOUGHT == 80
	PRINTL 成長させます
SIF BOUGHT == 81
	PRINTL EX化させます
SIF BOUGHT == 85
	PRINTL 自分の気持ちを伝えます
SIF BOUGHT == 86
	PRINTL 最高の妻にして奴隷である証を与えます
SIF BOUGHT == 87
	PRINTL 烙印を押して自分の妾にします
SIF BOUGHT == 98
	PRINTL 調教の記憶を消去します

IF BOUGHT == 86 || BOUGHT == 87
	PRINTL 誰に与えますか？
ELSE
	PRINTL 誰に使いますか？
ENDIF

;改行用変数
LOCAL:0 = 0
REPEAT CHARANUM
	TFLAG:COUNT = 0
	;別れ中のキャラには使えない
	SIF CFLAG:COUNT:21
		CONTINUE
	SIF BOUGHT == 70 && BASE:COUNT:0 == MAXBASE:COUNT:0
		CONTINUE
	SIF BOUGHT == 71 && (TALENT:COUNT:121 || TALENT:COUNT:122)
		CONTINUE
	SIF BOUGHT == 71 && F == 0 && TALENT:COUNT:55 == 0 && TALENT:COUNT:120 == 0 && TALENT:COUNT:127 == 0
		CONTINUE
	SIF BOUGHT == 72 && (TALENT:COUNT:121 == 0 || TALENT:COUNT:122)
		CONTINUE
	SIF BOUGHT == 73 && (TALENT:COUNT:130 || TALENT:COUNT:122)
		CONTINUE
	IF BOUGHT == 74 && (TALENT:COUNT:0 || TALENT:COUNT:122)
		SIF NO:COUNT != 14 || CFLAG:COUNT:0 || NAME_CSV(NO:COUNT, 1) != "ちびアリス"
			CONTINUE
		;主人時は不可
		SIF COUNT == 0
			CONTINUE
	ENDIF
	SIF BOUGHT == 75 && (TALENT:COUNT:110 || TALENT:COUNT:122)
		CONTINUE
	SIF BOUGHT == 76 && (TALENT:COUNT:109 || TALENT:COUNT:122)
		CONTINUE
	SIF BOUGHT == 77 && (TALENT:COUNT:130 == 0 || TALENT:COUNT:122)
		CONTINUE
	SIF BOUGHT == 78 && TALENT:COUNT:57 == 0
		CONTINUE
	SIF BOUGHT == 79 && (TALENT:COUNT:122 || (TALENT:COUNT:134 == 0 && EXP:COUNT:60 == 0) || BASE:COUNT:0 < 1000)
		CONTINUE
	SIF BOUGHT == 80 && TALENT:COUNT:100 == 0
		CONTINUE
	SIF BOUGHT == 81 && (CFLAG:COUNT:0 || ABLE_EX_CHANGES(COUNT) == 0)
		CONTINUE
	SIF BOUGHT == 85 && COUNT != TARGET
		CONTINUE
	SIF BOUGHT == 86 && COUNT != TARGET
		CONTINUE
	SIF BOUGHT == 87 && COUNT != TARGET
		CONTINUE
	SIF BOUGHT == 98 && COUNT == 0
		CONTINUE
	PRINTFORM [{COUNT,2}]%NAME:COUNT,16,LEFT%　
	IF BOUGHT == 70
		;元気になる薬は体力を表示して1行表示
		PRINTFORML 体力({BASE:COUNT:0,4}/{MAXBASE:COUNT:0,4})
		TFLAG:COUNT = 1
		CONTINUE
	ENDIF
	;SIF CFLAG:COUNT:1 == 2
		;PRINT 助手可
	
	;3行表示
	LOCAL:0 += 1
	IF LOCAL:0 == 3
		PRINTL 
		LOCAL:0 = 0
	ENDIF
	TFLAG:COUNT = 1
REND
SIF LOCAL:0 != 0
	PRINTL 
IF CHARANUM <= 100
	PRINTL [100] 戻る
ELSE
	PRINTL [1000][-1] 戻る
ENDIF

$INPUT_LOOP
INPUT
IF RESULT == -1 || (CHARANUM <= 100 && RESULT == 100) || RESULT == 1000
	ITEM:BOUGHT = 0
	;払い戻し
	MONEY += ITEMPRICE:BOUGHT
	RETURN 0
ELSE
	IF RESULT < 0 || RESULT >= CHARANUM
		PRINTFORML 正しい値を入力してください
		GOTO INPUT_LOOP
	ELSEIF TFLAG:RESULT == 0
		PRINTFORML 正しい値を入力してください
		GOTO INPUT_LOOP
	ENDIF
ENDIF

;TFLAG初期化
TFLAG:13 = 0
TFLAG:600 = 0
;体力回復
IF BOUGHT == 70
	PRINTFORMW ＜%NAME:RESULT%の体力が回復した＞
	BASE:RESULT:0 += 300
	SIF BASE:RESULT:0 > MAXBASE:RESULT:0
		BASE:RESULT:0 = MAXBASE:RESULT:0
	TFLAG:600 = 50
ENDIF
;ふたなり化
IF BOUGHT == 71
	PRINTFORMW ＜%NAME:RESULT%をふたなり化した＞
	TALENT:RESULT:120 = 0
	TALENT:RESULT:127 = 0
	TALENT:RESULT:121 = 1
	TFLAG:600 = 51
ENDIF
;ふたなりを消去
IF BOUGHT == 72
	PRINTFORMW ＜%NAME:RESULT%はふたなりではなくなった＞
	TALENT:RESULT:121 = 0
	TFLAG:600 = 52
ENDIF
;母乳体質
IF BOUGHT == 73
	PRINTFORMW ＜%NAME:RESULT%は母乳が出るようになった＞
	TALENT:RESULT:130 = 1
	TFLAG:600 = 53
ENDIF
;処女膜再生
IF BOUGHT == 74
	LOCAL = RESULT
	;条件が揃っているならアリスをSP化(東方専用)
	IF 0
		RESULT = LOCAL
		CALL ADD_SP_ALICE
	ELSE
		PRINTFORMW ＜%NAME:LOCAL%の処女膜が再生された＞
		TALENT:LOCAL:0 = 1
		;素質発覚
		SIF FLAG:2 == 1 && (CFLAG:60 & 1) == 0
			CFLAG:60 |= 1
	ENDIF
	TFLAG:600 = 54
ENDIF
;豊乳化
IF BOUGHT == 75
	;素質発覚（隠し様がないね）
	SIF FLAG:2 == 1 && (CFLAG:RESULT:60 & 32) == 0
			CFLAG:RESULT:60 |= 32
	IF TALENT:RESULT:109
		PRINTFORMW ＜%NAME:RESULT%の胸が大きくなった＞
		TALENT:RESULT:109 = 0
	ELSE
		IF TALENT:RESULT:100
			PRINTFORMW ＜%NAME:RESULT%の胸が体に不釣合いなまでに大きくなった＞
		ELSE
			PRINTFORMW ＜%NAME:RESULT%の胸がはち切れんばかりの大きさになった＞
		ENDIF
		TALENT:RESULT:110 = 1
	ENDIF
	TFLAG:600 = 55
ENDIF
;虚乳
IF BOUGHT == 76
	;素質発覚（隠し様がないね）
	SIF FLAG:2 == 1 && (CFLAG:RESULT:60 & 32) == 0
			CFLAG:RESULT:60 |= 32
	IF TALENT:RESULT:110
		PRINTFORMW ＜%NAME:RESULT%の胸が人並みに小さくなった＞
		PRINTFORMW %NAME:RESULT%はショックを受けているようだ

		TALENT:RESULT:110 = 0
	ELSE
		IF TALENT:RESULT:100
			PRINTFORMW ＜%NAME:RESULT%の胸が見かけ相当に薄くなった＞
			PRINTFORMW %NAME:RESULT%は少々ショックを受けているようだ
		ELSE
			PRINTFORMW ＜%NAME:RESULT%の胸が極端に薄くなった＞
			PRINTFORMW %NAME:RESULT%は愕然としている
		ENDIF
		TALENT:RESULT:109 = 1
	ENDIF
	TFLAG:600 = 56
ENDIF
;母乳治療
IF BOUGHT == 77
	PRINTFORMW ＜%NAME:RESULT%は母乳が出なくなった＞
	TALENT:RESULT:130 = 0
	TFLAG:600 = 57
ENDIF
;お漏らし治療
IF BOUGHT == 78
	PRINTFORMW ＜%NAME:RESULT%のお漏らし癖が治った＞
	TALENT:RESULT:57 = 0
	EXP:RESULT:31 = 0
	TFLAG:600 = 58
ENDIF
;卵を産ませる
IF BOUGHT == 79
	A = RESULT
	PRINTFORML ＜%NAME:A%に卵を産ませますか？＞
	PRINTW ※日付が数日飛びます
	DRAWLINE
	PRINTL [0] - 今はやめておく
	PRINTL [1] - 産ませる
	DRAWLINE
	$INPUT_LOOP_EGG
	INPUT
	IF RESULT == 1
		TARGET = A
		CALL LAY_EGG
	ELSEIF RESULT == 0
		MONEY += 20000
		RETURN 0
	ELSE
		PRINTFORML 正しい値を入力してください
		GOTO INPUT_LOOP_EGG
	ENDIF
ENDIF

;成長薬
IF BOUGHT == 80
	PRINTFORMW ＜%NAME:RESULT%の体が成長した＞
	TALENT:RESULT:100 = 0
	;剃毛パッチ追加
	IF MAXBASE:RESULT:8 == 0
		MAXBASE:RESULT:8 = 300
	ELSEIF MAXBASE:RESULT:8 == 300
		MAXBASE:RESULT:8 = 1000
	ENDIF
	;ここまで
	IF TALENT:RESULT:109
		PRINTFORMW ＜%NAME:RESULT%の胸が大きくなった＞
		TALENT:RESULT:109 = 0
	ELSEIF TALENT:RESULT:110 == 0
		PRINTFORMW ＜%NAME:RESULT%の胸がはち切れんばかりの大きさになった＞
		TALENT:RESULT:110 = 1
	ENDIF
ENDIF

;EX化
IF BOUGHT == 81

ENDIF

;記憶消去
IF BOUGHT == 98
	PRINTFORMW ＜%NAME:RESULT%は%CALLNAME:MASTER%との記憶を失った＞
	R = RESULT
	ADDCHARA NO:R

	TARGET = CHARANUM-1

	;口上用に一時的に素質追加処理
	TALENT:TARGET:85 = TALENT:R:85
	TALENT:TARGET:88 = TALENT:R:88
	TALENT:TARGET:89 = TALENT:R:89
	TALENT:TARGET:135 = TALENT:R:135
	TALENT:TARGET:76 = TALENT:R:76
	TALENT:TARGET:74 = TALENT:R:74
	TALENT:TARGET:75 = TALENT:R:75
	TALENT:TARGET:77 = TALENT:R:77
	TALENT:TARGET:78 = TALENT:R:78
	TALENT:TARGET:155 = TALENT:R:155
	TALENT:TARGET:79 = TALENT:R:79
	TALENT:TARGET:83 = TALENT:R:83
	MARK:TARGET:0 = MARK:R:0
	MARK:TARGET:1 = MARK:R:1
	MARK:TARGET:2 = MARK:R:2
	MARK:TARGET:3 = MARK:R:3

	;融通が利くように口上はここに
	TFLAG:600 = 59
	CALL KOJO_JUN

	;口上用に一時的に追加した素質の消去処理
	TALENT:TARGET:85 = 0
	TALENT:TARGET:88 = 0
	TALENT:TARGET:89 = 0
	TALENT:TARGET:135 = 0
	TALENT:TARGET:76 = 0
	TALENT:TARGET:74 = 0
	TALENT:TARGET:75 = 0
	TALENT:TARGET:77 = 0
	TALENT:TARGET:78 = 0
	TALENT:TARGET:155 = 0
	TALENT:TARGET:79 = 0
	TALENT:TARGET:83 = 0
	MARK:TARGET:0 = 0
	MARK:TARGET:1 = 0
	MARK:TARGET:2 = 0
	MARK:TARGET:3 = 0

	;汎用キャラは保存素質追加
	IF NO:TARGET == 99
		TALENT:TARGET:10 = TALENT:R:10
		TALENT:TARGET:11 = TALENT:R:11
		TALENT:TARGET:12 = TALENT:R:12
		TALENT:TARGET:13 = TALENT:R:13
		TALENT:TARGET:14 = TALENT:R:14
		TALENT:TARGET:15 = TALENT:R:15
		TALENT:TARGET:16 = TALENT:R:16
		TALENT:TARGET:17 = TALENT:R:17
		TALENT:TARGET:18 = TALENT:R:18
		TALENT:TARGET:20 = TALENT:R:20
		TALENT:TARGET:21 = TALENT:R:21
		TALENT:TARGET:22 = TALENT:R:22
		TALENT:TARGET:23 = TALENT:R:23
		TALENT:TARGET:24 = TALENT:R:24
		TALENT:TARGET:25 = TALENT:R:25
		TALENT:TARGET:26 = TALENT:R:26
		TALENT:TARGET:27 = TALENT:R:27
		TALENT:TARGET:28 = TALENT:R:28
		TALENT:TARGET:30 = TALENT:R:30
		TALENT:TARGET:31 = TALENT:R:31
		TALENT:TARGET:32 = TALENT:R:32
		TALENT:TARGET:33 = TALENT:R:33
		TALENT:TARGET:34 = TALENT:R:34
		TALENT:TARGET:35 = TALENT:R:35
		TALENT:TARGET:36 = TALENT:R:36
		TALENT:TARGET:37 = TALENT:R:37
		TALENT:TARGET:50 = TALENT:R:50
		TALENT:TARGET:51 = TALENT:R:51
		TALENT:TARGET:52 = TALENT:R:52
		TALENT:TARGET:53 = TALENT:R:53
		TALENT:TARGET:54 = TALENT:R:54
		TALENT:TARGET:55 = TALENT:R:55
		TALENT:TARGET:60 = TALENT:R:60
		TALENT:TARGET:61 = TALENT:R:61
		TALENT:TARGET:62 = TALENT:R:62
		TALENT:TARGET:63 = TALENT:R:63
		TALENT:TARGET:64 = TALENT:R:64
		TALENT:TARGET:70 = TALENT:R:70
		TALENT:TARGET:71 = TALENT:R:71
		TALENT:TARGET:72 = TALENT:R:72
		TALENT:TARGET:80 = TALENT:R:80
		TALENT:TARGET:81 = TALENT:R:81
		TALENT:TARGET:82 = TALENT:R:82
		TALENT:TARGET:83 = TALENT:R:83
		TALENT:TARGET:84 = TALENT:R:84
		TALENT:TARGET:87 = TALENT:R:87
		TALENT:TARGET:118 = TALENT:R:118
		TALENT:TARGET:132 = TALENT:R:132
	ENDIF
	TALENT:TARGET:0 = TALENT:R:0
	TALENT:TARGET:40 = TALENT:R:40
	TALENT:TARGET:41 = TALENT:R:41
	TALENT:TARGET:42 = TALENT:R:42
	TALENT:TARGET:43 = TALENT:R:43
	TALENT:TARGET:56 = TALENT:R:56
	TALENT:TARGET:100 = TALENT:R:100
	TALENT:TARGET:101 = TALENT:R:101
	TALENT:TARGET:102 = TALENT:R:102
	TALENT:TARGET:103 = TALENT:R:103
	TALENT:TARGET:104 = TALENT:R:104
	TALENT:TARGET:105 = TALENT:R:105
	TALENT:TARGET:106 = TALENT:R:106
	TALENT:TARGET:107 = TALENT:R:107
	TALENT:TARGET:108 = TALENT:R:108
	TALENT:TARGET:109 = TALENT:R:109
	TALENT:TARGET:110 = TALENT:R:110
	TALENT:TARGET:111 = TALENT:R:111
	TALENT:TARGET:112 = TALENT:R:112
	TALENT:TARGET:113 = TALENT:R:113
	TALENT:TARGET:114 = TALENT:R:114
	TALENT:TARGET:115 = TALENT:R:115
	TALENT:TARGET:116 = TALENT:R:116
	TALENT:TARGET:120 = TALENT:R:120
	TALENT:TARGET:121 = TALENT:R:121
	TALENT:TARGET:122 = TALENT:R:122
	TALENT:TARGET:124 = TALENT:R:124
	;被写経験がリセットされないようなので人気はそのまま
	TALENT:TARGET:126 = TALENT:R:126
	TALENT:TARGET:128 = TALENT:R:128
	TALENT:TARGET:130 = TALENT:R:130
	TALENT:TARGET:134 = TALENT:R:134
	TALENT:TARGET:150 = TALENT:R:150

	TALENT:TARGET:213 = TALENT:R:213
	TALENT:TARGET:214 = TALENT:R:214
	TALENT:TARGET:215 = TALENT:R:215
	TALENT:TARGET:218 = TALENT:R:218
	
	
	EXP:TARGET:0 = EXP:R:0
	EXP:TARGET:1 = EXP:R:1
	EXP:TARGET:2 = EXP:R:2
	EXP:TARGET:3 = EXP:R:3
	EXP:TARGET:10 = EXP:R:10
	EXP:TARGET:11 = EXP:R:11
	EXP:TARGET:20 = EXP:R:20
	EXP:TARGET:21 = EXP:R:21
	EXP:TARGET:22 = EXP:R:22
	EXP:TARGET:23 = EXP:R:23
	EXP:TARGET:30 = EXP:R:30
	EXP:TARGET:31 = EXP:R:31
	EXP:TARGET:32 = EXP:R:32
	EXP:TARGET:40 = EXP:R:40
	EXP:TARGET:41 = EXP:R:41
	EXP:TARGET:50 = EXP:R:50
	EXP:TARGET:51 = EXP:R:51
	EXP:TARGET:52 = EXP:R:52
	EXP:TARGET:53 = EXP:R:53
	EXP:TARGET:54 = EXP:R:54
	EXP:TARGET:55 = EXP:R:55
	EXP:TARGET:56 = EXP:R:56
	EXP:TARGET:60 = EXP:R:60
	EXP:TARGET:61 = EXP:R:61
	EXP:TARGET:90 = EXP:R:90
	EXP:TARGET:91 = EXP:R:91
	EXP:TARGET:92 = EXP:R:92
	EXP:TARGET:93 = EXP:R:93
	ABL:TARGET:Ｃ感覚 = ABL:R:Ｃ感覚
	ABL:TARGET:Ｖ感覚 = ABL:R:Ｖ感覚
	ABL:TARGET:Ａ感覚 = ABL:R:Ａ感覚
	ABL:TARGET:Ｂ感覚 = ABL:R:Ｂ感覚
	
	BASE:TARGET:0 = BASE:R:0
	MAXBASE:TARGET:0 = MAXBASE:R:0
;	BASE:TARGET:1 = BASE:R:1
;	MAXBASE:TARGET:1 = MAXBASE:R:1
	MAXBASE:TARGET:2 = MAXBASE:R:2
	MAXBASE:TARGET:3 = MAXBASE:R:3
	BASE:TARGET:4 = BASE:R:4
	MAXBASE:TARGET:4 = MAXBASE:R:4
	BASE:TARGET:5 = BASE:R:5
	MAXBASE:TARGET:5 = MAXBASE:R:5
	
	
	CFLAG:TARGET:15 = CFLAG:R:15
	CFLAG:TARGET:17 = CFLAG:R:17
	CFLAG:TARGET:18 = CFLAG:R:18
	CFLAG:TARGET:19 = CFLAG:R:19
	CFLAG:TARGET:20 = CFLAG:R:20
	;加入した時ではなく記憶を消した時の異常経験の値を入れるように
	CFLAG:TARGET:22 = EXP:R:50
	CFLAG:TARGET:81 = CFLAG:R:81
	CFLAG:TARGET:110 = CFLAG:R:110
	CFLAG:TARGET:111 = CFLAG:R:111
	
	;妊娠関連
	MARK:TARGET:89 = MARK:R:89
	MARK:TARGET:90 = MARK:R:90
	
	;月経
	CFLAG:TARGET:33 = CFLAG:R:33
	TALENT:TARGET:137 = TALENT:R:137
	TALENT:TARGET:138 = TALENT:R:138

	TALENT:TARGET:151 = 1
	;記憶消去回数
	EXP:TARGET:98 = EXP:R:98 + 1
	CFLAG:32 = 0
	;口上のバージョン情報も引き継がせる
	CFLAG:R:KOJO_VERSION = CFLAG:TARGET:KOJO_VERSION
	;恋慕
	SIF TALENT:R:85
		CFLAG:TARGET:32 |= 1
	;親愛
	SIF TALENT:R:88
		CFLAG:TARGET:32 |= 2
	;相愛
	SIF TALENT:R:89
		CFLAG:TARGET:32 |= 4
	;恋人
	SIF TALENT:R:135
		CFLAG:TARGET:32 |= 8
	;淫乱
	SIF TALENT:R:76
		CFLAG:TARGET:32 |= 16
	;淫壷
	SIF TALENT:R:74
		CFLAG:TARGET:32 |= 32
	;淫核
	SIF TALENT:R:75
		CFLAG:TARGET:32 |= 64
	;尻穴狂い
	SIF TALENT:R:77
		CFLAG:TARGET:32 |= 128
	;淫乳
	SIF TALENT:R:78
		CFLAG:TARGET:32 |= 256
	;キス魔
	SIF TALENT:R:155
		CFLAG:TARGET:32 |= 512
	;マゾ
	SIF TALENT:R:79
		CFLAG:TARGET:32 |= 1024
	;サド
	SIF TALENT:R:83
		CFLAG:TARGET:32 |= 2048
	;苦痛依存Lv3
	SIF MARK:R:0 == 3
		CFLAG:TARGET:32 |= 4096
	;快楽依存Lv3
	SIF MARK:R:1 == 3
		CFLAG:TARGET:32 |= 8192
	;既成事実Lv3
	SIF MARK:R:2 == 3
		CFLAG:TARGET:32 |= 16384
	;反発感情Lv3
	SIF MARK:R:3 == 3
		CFLAG:TARGET:32 |= 32768
	DELCHARA R
	TARGET = CHARANUM-1
	;助手の記憶を消すと分裂するので助手無しに
	SIF TARGET == ASSI
		ASSI = -1
	RETURN 0
ENDIF

;単体エンド
IF BOUGHT == 85
	PRINTFORMW %NAME:MASTER%は%NAME:TARGET%の左手を引き寄せると、その薬指に指輪をはめてやった
	TFLAG:13 = 7
	CALL SELF_KOJO
	PRINTFORMW %NAME:TARGET%は頬を染めて%NAME:MASTER%の気持ちを受け入れる旨を伝えた

	;一線越えない消滅
	IF TALENT:27
		PRINTFORMW その顔は今までに無く幸福に満ち、すべてを吹っ切ったように見えた
		PRINTFORMW %NAME:TARGET%は[%TALENTNAME:27%]を失った
		TALENT:27 = 0
	ENDIF
	PRINTFORMW %NAME:TARGET%と寄り添い、長い間抱擁を交し合っていた……
	;相愛取得
	IF TALENT:89 == 0
		PRINTFORMW %NAME:TARGET%は[%TALENTNAME:89%]を得た
		TALENT:89 = 1
	ENDIF
	;売却不可フラグ
	CFLAG:7 = 1
	WAIT

	IF FLAG:1 == 9
		;FLAG:1が9のときは特殊ハーレムエンドへ。
		;“IF FLAG:1 == 9”を奴隷エンドと分けることは可能
		;烙印9＋エンゲージのハーレムエンドはIF ITEM:85で仕分けすればいけるか？
		CALL SLAVE_ENDING
	ELSE
		CALL SINGLE_ENDING
	ENDIF
;	IF FLAG:5 != 9
;		PRINTFORMW ―――単体エンド条件達成―――
;		PRINTFORMW …………
;		PRINTFORMW ………
;		PRINTFORMW ……
;		CALL GAME_CONTINUE
;	ENDIF
ENDIF

;奴隷エンド
IF BOUGHT == 86
	PRINTFORMW %NAME:MASTER%は%NAME:TARGET%の体を引き寄せると、その首に赤い首輪をかけてやった
	TFLAG:13 = 14
	CALL SELF_KOJO
	PRINTFORML %NAME:TARGET%は呆けたような表情を浮かべたものの、我に帰ると%NAME:MASTER%にしなだれかかり
	PRINTFORMW とろんとした瞳で見上げて服従の誓いを述べた
	PRINTFORM %NAME:TARGET%の名前が刻印されたネームプレートが
	IF TIME == 0
		PRINT 夕陽を受けて
	ELSE
		PRINT 月の光を受けて
	ENDIF
	PRINTW きらりと光っている……
	PRINTL  
	;一線越えない消滅
	IF TALENT:27
		PRINTFORMW %NAME:TARGET%は[%TALENTNAME:27%]を失った
		TALENT:27 = 0
	ENDIF
	;貞操観念消滅
	IF TALENT:30
		PRINTFORMW %NAME:TARGET%は[%TALENTNAME:30%]を失った
		TALENT:30 = 0
	ENDIF
	PRINTFORMW %NAME:MASTER%はしなだれかかっている%NAME:TARGET%の頭を長い間撫でながら
	PRINTFORMW 空を見上げ、今後の調教に思いを馳せていった……
	PRINTL  
	;服従取得
	IF TALENT:180 == 0
		PRINTFORMW %NAME:TARGET%は[%TALENTNAME:180%]を得た
		TALENT:180 = 1
	ENDIF
	;隷属取得
	IF TALENT:182 == 0
		PRINTFORMW %NAME:TARGET%は[%TALENTNAME:182%]を得た
		TALENT:182 = 1
	ENDIF
	;売却不可フラグ(首輪売却を不可にしたい場合は“;”を外してください)
;	CFLAG:7 = 1
	WAIT
	IF FLAG:1 == 9
		;FLAG:1が9のときは特殊ハーレムエンドへ。
		;“IF FLAG:1 == 9”を奴隷エンドと分けることは可能
		;烙印9＋赤い首輪のハーレムエンドはIF ITEM:86で仕分けすればいけるか？
		CALL SLAVE_ENDING
	ELSE
		CALL SINGLE_ENDING
	ENDIF

;	IF FLAG:5 != 9
;		PRINTFORMW ―――奴隷エンド条件達成―――
;		PRINTFORMW …………
;		PRINTFORMW ………
;		PRINTFORMW ……
;		CALL GAME_CONTINUE
;	ENDIF
ENDIF

;烙印
IF BOUGHT == 87
	ITEM:87 = 0
	PRINTFORMW ※注意！　%NAME:TARGET%に烙印を押すと二度と別れられなくなります。
	PRINTW それでもいいですか？
	DRAWLINE
	PRINTFORML [0] - %NAME:TARGET%に烙印を押す
	PRINTL [100] - やめる
	DRAWLINE
	$INPUT_LOOP_RAKUIN
	INPUT
	IF RESULT == 100
		MONEY += 100000
		RETURN 0
	ELSEIF RESULT == 0
		PRINTFORMW %NAME:MASTER%は%NAME:TARGET%に烙印を押した
		;TFLAG:13 = 14を奴隷エンド口上、TFLAG:13 = 15を烙印が押された時の口上とする
		TFLAG:13 = 15
		CALL SELF_KOJO
		FLAG:1 += 1
		PRINTFORMW %NAME:TARGET%は%NAME:MASTER%の所有物となったことに
		PRINTFORMW この上ない悦びを感じているようだ……
		;一線越えない消滅
		IF TALENT:27
			PRINTFORMW %NAME:TARGET%は[%TALENTNAME:27%]を失った
			TALENT:27 = 0
		ENDIF
		PRINTFORMW %NAME:MASTER%は%NAME:TARGET%の躰に刻まれた烙印を指先で撫で、
		PRINTFORMW %NAME:TARGET%の従属心を煽りたてた
		PRINTL  
		;服従取得
		IF TALENT:180 == 0
			PRINTFORMW %NAME:TARGET%は[%TALENTNAME:180%]を得た
			TALENT:180 = 1
		ENDIF
		;烙印取得
		IF TALENT:181 == 0
			PRINTFORMW %NAME:TARGET%は[%TALENTNAME:181%]を得た
			TALENT:181 = 1
		ENDIF
		;売却不可フラグ
		CFLAG:7 = 1
		PRINTFORMW ―――%NAME:TARGET%は身も心も%NAME:MASTER%の支配下になりました―――
		PRINTFORMW …………
		PRINTFORMW ………
		PRINTFORMW ……
;		IF FLAG:1 < 9
;			PRINTFORMW ＜購入できる%ITEMNAME:87%は残り{9-FLAG:1}個です＞
;		ELSE
;			PRINTFORMW ＜%ITEMNAME:87%は売り切れました＞
;		ENDIF
		PRINTFORMW ＜%NAME:TARGET%と別れられなくなりました＞
		WAIT
	ELSE
		PRINTFORML 正しい値を入力してください
		GOTO INPUT_LOOP_RAKUIN
	ENDIF
	RETURN 1
ENDIF

;口上表示。各アイテム使用時にTFLAG:600設定（設定されていないアイテムもあり）
T = TARGET
TARGET = RESULT
CALL KOJO_JUN
TARGET = T

;-------------------------------------------------
;虹の飴玉(性転換)
;-------------------------------------------------
@USE_DRUG_83
;現状では主人専用の性転換処理
IF TALENT:MASTER:122
	;オトコの場合、女性になる
	PRINTFORML %CALLNAME:MASTER%は突然体全体が光に包まれるような感覚を感じた
	PRINTW すると、意識がぼんやりとし、まるで光の海を漂うような浮遊感に包まれた……
	PRINTL 少しして、体を包む光が消失したところで、体を確認すると、
	PRINTFORML %CALLNAME:MASTER%の体はすっかり女性になっていた……
	PRINTW  
	PRINTFORMW ＜%CALLNAME:MASTER%は女性になった＞
	TALENT:MASTER:122 = 0

	;以下の素質があれば消去し記録保存
	;童貞
	IF TALENT:MASTER:154
		TALENT:MASTER:154 = 0
		CFLAG:MASTER:41 |= 1p7
	ENDIF
	;早漏
	IF TALENT:MASTER:133
		TALENT:MASTER:133 = 0
		CFLAG:MASTER:41 |= 1p8
	ENDIF

	;以下の記録があれば素質復元
	;ふたなり
	IF CFLAG:MASTER:41 & 1p0
		TALENT:MASTER:121 = 1
	ELSE
		TALENT:MASTER:121 = 0
	ENDIF
	;不思議な根
	IF CFLAG:MASTER:41 & 1p1
		TALENT:MASTER:120 = 1
	ELSE
		TALENT:MASTER:120 = 0
	ENDIF
	;具現
	IF CFLAG:MASTER:41 & 1p2
		TALENT:MASTER:127 = 1
	ELSE
		TALENT:MASTER:127 = 0
	ENDIF
	;貧乳
	IF CFLAG:MASTER:41 & 1p3
		TALENT:MASTER:109 = 1
	ELSE
		TALENT:MASTER:109 = 0
	ENDIF
	;巨乳
	IF CFLAG:MASTER:41 & 1p4
		TALENT:MASTER:110 = 1
	ELSE
		TALENT:MASTER:110 = 0
	ENDIF
	;処女
	IF CFLAG:MASTER:41 & 1p5
		TALENT:MASTER:0 = 1
	ELSE
		TALENT:MASTER:0 = 0
	ENDIF
	;母乳体質
	IF CFLAG:MASTER:41 & 1p6
		TALENT:MASTER:130 = 1
	ELSE
		TALENT:MASTER:130 = 0
	ENDIF
	;早漏（ふたなりの場合）
	IF (CFLAG:MASTER:41 & 1p8) && TALENT:MASTER:121
		TALENT:MASTER:133 = 1
	ELSE
		TALENT:MASTER:133 = 0
	ENDIF
ELSE
	;女性の場合、オトコになる
	PRINTFORML %CALLNAME:MASTER%は突然体全体が光に包まれるような感覚を感じた
	PRINTW すると、意識がぼんやりとし、まるで光の海を漂うような浮遊感に包まれた……
	PRINTL 少しして、体を包む光が消失したところで、体を確認すると、
	PRINTFORML %CALLNAME:MASTER%の体はすっかり男性になっていた……
	PRINTW  
	PRINTFORMW ＜%CALLNAME:MASTER%は男性になった＞
	TALENT:MASTER:122 = 1

	;以下の記録があれば素質復元
	;童貞
	IF CFLAG:MASTER:41 & 1p7
		TALENT:MASTER:154 = 1
	ELSE
		TALENT:MASTER:154 = 0
	ENDIF
	;早漏
	SIF CFLAG:MASTER:41 & 1p8
		TALENT:MASTER:133 = 1

	;CFLAG:MASTER:41を一旦初期化
	CFLAG:MASTER:41 = 0
	
	;以下の素質があれば消去し記録保存
	;ふたなり
	IF TALENT:MASTER:121
		TALENT:MASTER:121 = 0
		CFLAG:MASTER:41 |= 1p0
	ENDIF
	;不思議な根
	IF TALENT:MASTER:120
		TALENT:MASTER:120 = 0
		CFLAG:MASTER:41 |= 1p1
	ENDIF
	;具現
	IF TALENT:MASTER:127
		TALENT:MASTER:127 = 0
		CFLAG:MASTER:41 |= 1p2
	ENDIF
	;貧乳
	IF TALENT:MASTER:109
		TALENT:MASTER:109 = 0
		CFLAG:MASTER:41 |= 1p3
	ENDIF
	;巨乳
	IF TALENT:MASTER:110
		TALENT:MASTER:110 = 0
		CFLAG:MASTER:41 |= 1p4
	ENDIF
	;処女
	IF TALENT:MASTER:0
		TALENT:MASTER:0 = 0
		CFLAG:MASTER:41 |= 1p5
	ENDIF
	;母乳体質
	IF TALENT:MASTER:130
		TALENT:MASTER:130 = 0
		CFLAG:MASTER:41 |= 1p6
	ENDIF
ENDIF

