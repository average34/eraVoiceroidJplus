@EVENTEND
#LATER
;押し倒されフラグONならパートナーを介抱する
IF TFLAG:51 == 2
	PRINTFORML %CALLNAME:TARGET%を休ませました。
;通常
ELSE
	PRINTFORML %CALLNAME:TARGET%と一旦別れました。
ENDIF

;体力等調整処理(最大値まで)
CALL LIFE_LIMIT_MAXBASE

;リング資金稼ぎ
CALL EARN_MONEY_TM

;調教後行為のチェック
CALL SELF_CHECK

;搾乳した母乳の売却
CALL SELL_MILK

;変化した素質の復帰
CALL RETURN_TALENT

;スイートポテトとワインで素敵なディナーを作る秋姉妹
;SIF TFLAG:73 > 0 || TFLAG:74 > 0
;	CALL SELL_DINNER

;調教時に録画したビデオを売却
CALL SELL_VIDEO

;気力・体力の上昇チェック
SIF FLAG:62 & 512
	CALL EVENT_GROWTH

;入手した尻子玉を展示室に
;SIF CFLAG:9 == 1
;	CALL GET_SHIRIKODAMA

;入手した母乳を展示室に
;SIF CFLAG:11 == 1
;	CALL GET_MILK

;入手した黄金水を展示室に
;SIF CFLAG:8 == 1
;	CALL GET_GOLD_WATER

;何の珠を得られたか
CALL JUEL_CHECK

;否定の珠の打ち消しチェック
CALL DENIAL_CHECK

BEGIN ABLUP

;-------------------------------------------------
;何の珠を得られたか
;-------------------------------------------------
@JUEL_CHECK
VARSET LOCAL, 0

;PALAMから取得する珠の種類・量を判断するためPALAMの並び設定使用
CALL PALAM_SORT
REPEAT A
	;並べ直したPALAMをLOCALに代入
	LOCAL = X:COUNT
	
	IF PALAM:LOCAL < PALAMLV:1
		G = 0
	ELSEIF PALAM:LOCAL < PALAMLV:1*3
		G = 1
	ELSEIF PALAM:LOCAL < PALAMLV:2
		G = 2
	ELSEIF PALAM:LOCAL < PALAMLV:2*3
		G = 10
	ELSEIF PALAM:LOCAL < PALAMLV:3
		G = 20
	ELSEIF PALAM:LOCAL < PALAMLV:3*2
		G = 100
	ELSEIF PALAM:LOCAL < PALAMLV:4
		G = 200
	ELSEIF PALAM:LOCAL < PALAMLV:5
		G = 1000
	ELSEIF PALAM:LOCAL < PALAMLV:6
		G = 2000
	ELSEIF PALAM:LOCAL < PALAMLV:7
		G = 3000
	ELSEIF PALAM:LOCAL < PALAMLV:8
		G = 5000
	ELSEIF PALAM:LOCAL < PALAMLV:9
		G = 8000
	ELSEIF PALAM:LOCAL < PALAMLV:10
		G = 12000
	ELSEIF PALAM:LOCAL < PALAMLV:11
		G = 25000
	ELSEIF PALAM:LOCAL < PALAMLV:12
		G = 40000
	ELSEIF PALAM:LOCAL < PALAMLV:13
		G = 60000
	ELSEIF PALAM:LOCAL < PALAMLV:14
		G = 70000
	ELSEIF PALAM:LOCAL < PALAMLV:15
		G = 80000
	ELSEIF PALAM:LOCAL < PALAMLV:16
		G = 100000
	ELSEIF PALAM:LOCAL < PALAMLV:17
		G = 200000
	ELSEIF PALAM:LOCAL < PALAMLV:18
		G = 400000
	ELSEIF PALAM:LOCAL < PALAMLV:19
		G = 500000
	ELSEIF PALAM:LOCAL < PALAMLV:20
		G = 600000
	ELSEIF PALAM:LOCAL < PALAMLV:21
		G = 800000
	ELSEIF PALAM:LOCAL < PALAMLV:22
		G = 1000000
	ELSEIF PALAM:LOCAL < PALAMLV:23
		G = 2000000
	ELSEIF PALAM:LOCAL < PALAMLV:24
		G = 4000000
	ELSEIF PALAM:LOCAL < PALAMLV:25
		G = 5000000
	ELSEIF PALAM:LOCAL < PALAMLV:26
		G = 6000000
	ELSEIF PALAM:LOCAL < PALAMLV:27
		G = 8000000
	ELSEIF PALAM:LOCAL < PALAMLV:28
		G = 10000000
	ELSEIF PALAM:LOCAL < PALAMLV:29
		G = 20000000
	ELSEIF PALAM:LOCAL < PALAMLV:30
		G = 40000000
	ELSEIF PALAM:LOCAL < PALAMLV:31
		G = 50000000
	ELSEIF PALAM:LOCAL < PALAMLV:32
		G = 70000000
	ELSEIF PALAM:LOCAL < PALAMLV:33
		G = 100000000
	ELSEIF PALAM:LOCAL < PALAMLV:34
		G = 500000000
	ELSEIF PALAM:LOCAL < PALAMLV:35
		G = 700000000
	ELSE
		G = 1000000000
	ENDIF
	
	IF LOCAL == 0
		;快Ｃの珠取得
		GOTJUEL:LOCAL += G + EX:0 * 1000
	ELSEIF LOCAL == 1
		;快Ｖの珠取得
		GOTJUEL:LOCAL += G + EX:1 * 1000
	ELSEIF LOCAL == 2
		;快Ａの珠取得
		GOTJUEL:LOCAL += G + EX:2 * 1000
	ELSEIF LOCAL == 14
		;快Ｂの珠取得
		GOTJUEL:LOCAL += G + EX:3 * 1000
	ELSEIF LOCAL == 18
		;快Ｍの珠取得
		GOTJUEL:LOCAL += G + EX:6 * 1000
	ELSEIF LOCAL == 11 || LOCAL == 12 || LOCAL == 13
		;反感、不快、抑鬱のPALAMから否定の珠を取得
		GOTJUEL:100 += G
	ELSE
		GOTJUEL:LOCAL += G
	ENDIF
REND

VARSET C, 0
VARSET D, 0
;JUELの並び設定
CALL JUEL_SORT
REPEAT A
	;並べ直したJUELをLOCALに代入
	LOCAL = X:COUNT
	;JUELの最高桁数取得
	T = JUEL:LOCAL
	CALL GET_DIGIT
	SIF C < RESULT
		C = RESULT
	;GOTJUELの最高桁数取得
	T = GOTJUEL:LOCAL
	CALL GET_DIGIT
	SIF D < RESULT
		D = RESULT
REND

;JUELの並び設定
CALL JUEL_SORT
REPEAT A
	;並べ直したJUELをLOCALに代入
	LOCAL = X:COUNT
	
	;否定の宝珠＋取得否定の宝珠がない場合をまず弾く
	IF LOCAL == 100 && JUEL:100 == 0 && GOTJUEL:100 == 0
		GOTJUEL:LOCAL = -1
		CONTINUE
	;否定の宝珠以外の表示において、相殺がない場合には、新規獲得宝珠のない宝珠は弾く
	ELSEIF LOCAL != 100 && JUEL:100 == 0 && GOTJUEL:100 == 0 && GOTJUEL:LOCAL == 0
		GOTJUEL:LOCAL = -1
		CONTINUE
	;否定の宝珠以外で相殺がある場合、宝珠＋取得宝珠がない宝珠を弾く
	ELSEIF LOCAL != 100 && JUEL:LOCAL == 0 && GOTJUEL:LOCAL == 0
		GOTJUEL:LOCAL = -1
		CONTINUE
	ENDIF

	;「今回の行動で」や「以上の珠を得ました。」の表示を判断するためにLOCAL:1を使用
	LOCAL:1 += 1
	;初めて表示がある場合は仕切りと冒頭の表示をする
	IF LOCAL:1 == 1
		DRAWLINE
		PRINTL 今回の行動で
	ENDIF
	;色分けONで否定の宝珠表示のときは色を変える
	SIF FLAG:23 & 256 && LOCAL == 100
		SETCOLOR 0xC07070

	PRINTFORML %PALAMNAME:LOCAL%の珠 ({JUEL:LOCAL,C}）＋（{GOTJUEL:LOCAL,D})
	JUEL:LOCAL += GOTJUEL:LOCAL

	;色分けONで否定の宝珠表示のときの後始末
	SIF FLAG:23 & 256 && LOCAL == 100
		RESETCOLOR
	
REND
;獲得宝珠表示があった場合のみ末尾の表示をする
SIF LOCAL:1 > 0
	PRINTW 以上の珠を得ました。

;-------------------------------------------------
;否定の珠の打ち消しチェック
;-------------------------------------------------
@DENIAL_CHECK
SIF JUEL:100 == 0
	RETURN 0
DRAWLINE
PRINTL 否定の珠と他の珠の打ち消しが発生しています。

$LABEL_1
A = RAND:4 + 4
SIF A == 7
	A = 15
B = JUEL:100 / 2
SIF B == 0 && JUEL:100 > 0
	B = 1
SIF JUEL:A < B
	B = JUEL:A
JUEL:A -= B
JUEL:100 -= B

SIF B > 0
	PRINTFORML %PALAMNAME:A%の珠－{B}減少
SIF JUEL:100 > 0 && (JUEL:4 + JUEL:5 + JUEL:6 + JUEL:15) > 0
	GOTO LABEL_1

$LABEL_2
A = RAND:3 + 8
B = JUEL:100 / 2
SIF B == 0 && JUEL:100 > 0
	B = 1
SIF JUEL:A < B
	B = JUEL:A
JUEL:A -= B
JUEL:100 -= B
SIF B > 0
	PRINTFORML %PALAMNAME:A%の珠－{B}個減少
SIF JUEL:100 > 0 && (JUEL:8 + JUEL:9 + JUEL:10) > 0
	GOTO LABEL_2

DRAWLINE
PRINTL その結果、
;JUELの並び設定
CALL JUEL_SORT
REPEAT A
	;並べ直したJUELをLOCALに代入
	LOCAL = X:COUNT
	;JUELの最高桁数取得
	T = JUEL:LOCAL
	CALL GET_DIGIT
	SIF C < RESULT
		C = RESULT
REND

REPEAT A
	;並べ直したJUELをLOCALに代入
	LOCAL = X:COUNT

	;色分けONで否定の宝珠表示のときは色を変える
	SIF FLAG:23 & 256 && LOCAL == 100
		SETCOLOR 0xC07070

	SIF GOTJUEL:LOCAL != -1
		PRINTFORML %PALAMNAME:LOCAL%の珠 → ({JUEL:LOCAL,C})

	;色分けONで否定の宝珠表示のときの後始末
	SIF FLAG:23 & 256 && LOCAL == 100
		RESETCOLOR
REND

PRINTW 以上のように変化しました。

;-------------------------------------------------
;桁数取得
;Tの桁数を取得しRESULTに代入
;-------------------------------------------------
@GET_DIGIT
LOCAL:1 = 100000000000000000
LOCAL:2 = 18
FOR LOCAL, 0, 19
	SIF LOCAL:2 == 0
		RETURN 0
	IF (T / LOCAL:1) >= 1
		RETURN LOCAL:2
	ELSE
		LOCAL:1 /= 10
		LOCAL:2 -= 1
	ENDIF
NEXT

;-------------------------------------------------
;一時的な素質変化の復帰
;-------------------------------------------------
@RETURN_TALENT
;TEQUIP:40で元の素質を記録
;1p0	1,貧乳
;1p1	2,並乳
;1p2	4,巨乳
;1p3	8,小型体型なし
;1p4	16,小型体型
;1p5	32,獣耳なし
;1p6	64,紫色の秘薬使用判定
;1p7	128,濡れにくい
;1p8	256,C鈍感
;1p9	512,V鈍感
;1p10	1024,A鈍感
;1p11	2048,B鈍感
;1p12	4096,娼婦の秘薬使用判定
;1p13	8192,性別反転
;1p14	16384,猫舌
;1p15	羽
;1p16	しっぽ
;1p17	M鈍感

;胸の復帰
IF TEQUIP:40 & 7
	TALENT:貧乳 = 0
	TALENT:巨乳 = 0
	IF TEQUIP:40 & 1
		TALENT:貧乳 = 1
	ELSEIF TEQUIP:40 & 4
		TALENT:巨乳 = 1
	ENDIF
ENDIF
;体型を正常に
SIF TEQUIP:40 & 8
	TALENT:小柄体型 = 0

SIF TEQUIP:40 & 16
	TALENT:小柄体型 = 1

;獣耳喪失
SIF TEQUIP:40 & 32
	TALENT:動物耳 = 0

;魔性のテクニック喪失
SIF TEQUIP:40 & 4096
	ABL:技巧 -= 10

;超敏感体質喪失
IF TEQUIP:40 & 64
	;有利素質は手抜き
	TALENT:濡れやすい -= 1
	TALENT:Ｃ敏感 -= 1
	TALENT:Ｖ敏感 -= 1
	TALENT:Ａ敏感 -= 1
	TALENT:Ｂ敏感 -= 1
	TALENT:Ｍ敏感 -= 1
	SIF (TEQUIP:40 & 128) > 0
		TALENT:濡れにくい = 1
	SIF (TEQUIP:40 & 256) > 0
		TALENT:Ｃ鈍感 = 1
	SIF (TEQUIP:40 & 512) > 0
		TALENT:Ｖ鈍感 = 1
	SIF (TEQUIP:40 & 1024) > 0
		TALENT:Ａ鈍感 = 1
	SIF (TEQUIP:40 & 2048) > 0
		TALENT:Ｂ鈍感 = 1
	SIF (TEQUIP:40 & 1p17) > 0
		TALENT:Ｍ鈍感 = 1
ENDIF

;性別を元に戻す
IF TEQUIP:40 & 1p13
	;性別反転。虹の飴玉(性転換)の処理を利用
	CALL USE_DRUG_83
ENDIF

;猫舌喪失
SIF TEQUIP:40 & 1p14
	TALENT:猫舌 = 0

;羽喪失
SIF TEQUIP:40 & 1p15
	TALENT:羽 = 0

;しっぽ喪失
SIF TEQUIP:40 & 1p16
	TALENT:しっぽ = 0

